{"instance_id": "facebook__zstd-2130", "rag_files": [{"filename": "2130.txt", "content": "repo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_freeErr.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCCtxSize.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.compressBegin.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZBUFF.compressInit.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_internal.h_ZSTD_CCtx.s.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_zstd_internal.h_ZSTD.freeCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.freeCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_CCtx.getParameter.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCDictSize.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT.initJobCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_adaptiveMode.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.copyCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_decompress.c_init_frame.context.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_compressStream2.simpleArgs.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_internal.h_ZSTD.defaultFreeFunction.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_decompress.c_ZSTD_initDCtx_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT.freeCCtxPool.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_compressBegin.usingDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compressEnd.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCStreamSize.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_CStream.s.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_createCCtxPool_unsigned.nbThreads.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_resetCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT.freeCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.CCtxWorkspaceBound.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c.prime5bytes.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_internal.h_ZSTD_defaultAllocFunction_void_opaque_size_t.size.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_cLevel.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.compressStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.resetCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_sizeof.CCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v04.h_ZSTDv04.resetDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.resetCStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.estimateCStreamSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_CCtxParams_init.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_getCCtx_ZSTDMT_CCtxPool.pool.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_ZBUFF_createCCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_resetCStream.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_internal.h_ZSTD_compress_advanced.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress_test.c.workspace.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.resetCStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_compress_advanced.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v05.c_ZSTDv05.decompressContinue.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_cwksp.h_ZSTD_cwksp_clear.tables.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_expandCCtxPool_ZSTDMT_CCtxPool_srcPool_int.nbWorkers.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_sizeof.CCtxPool.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compressCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.compressContinue.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_createCCtx_advanced_ZSTD_customMem.customMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v03.h_ZSTDv03.freeDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_internal.h_ZSTD.free.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_createCStream_advanced_ZSTD_customMem.customMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_zstd_internal.h_repStartValue_ZSTD_REP.NUM.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_CCtx.loadDictionary.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCCtxSize_advanced.usingCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_internal.h_ZSTD_initCStream.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_sizeof.CCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_freeCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.freeCDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCCtxSize.usingCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_memLimit.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_ZSTD_initDCtx.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_copyCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_initCStream.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.insertBlock.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_initCStream.usingCDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_estimateCCtxSize.usingCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_internal.h_ZSTD_window.init.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_initCStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v01.c_ZSTD.frameHeaderSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v04.c_ZSTDv04.freeDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.h_ZSTDMT.getNbWorkers.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_resetCCtx.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCStreamSize_advanced.usingCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_freePreferences.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress_test.c_zstd_decompress_test.open.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_compressBegin.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compressBegin.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_msan_test.shadow.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_POOL_create_size_t_numThreads_size_t.queueSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compressBegin.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_usingCDict.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_resetCStream.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v02.c_ZSTD.resetDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.h_ZSTDMT.getMTCtxParameter.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_initCStream_ZSTD_parameters_params_unsigned_long_long_pledgedSrcSize_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_asan_poison_memory.region.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.continueCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_FSE.decompress.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_ZSTD_initStaticDCtx_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_test.c_buffer.in.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_CCtxParams.setParameter.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZBUFF.freeCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_compressStream.generic.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.CDictWorkspaceBound.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_createCCtx_advanced_ZSTD_customMem.customMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.compressEnd.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_ZSTD_DStream.s.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.h_ZSTDMT_initCStream.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.estimateCCtxSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.initCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_createCCtx_advanced_unsigned_nbWorkers_ZSTD_customMem.cMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.compressStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.compressStream2.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v04.c_ZSTD_createDCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_lazy.h_ZSTD_compressBlock.greedy.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_WorkQueue.h_anonymous.function.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_ResourcePool.h_anonymous.function.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_resetCStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_createCCtx_unsigned.numJobs.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_createCCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_initCCtx_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.decompressBegin.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c.kNullRoundBuff.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_freeDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v01.h_ZSTDv01_createDCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.initCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD_initDStream_size_t_maxWindowSize_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_internal.state.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_createCCtx_advanced_unsigned_nbThreads_ZSTD_customMem.cMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_ZBUFF.compressInit.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.h_ZSTDMT_sizeof.CCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v07.c_ZSTDv07_createDCtx_advanced_ZSTDv07_customMem.customMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_resetCCtx.byCopyingCDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v07.c_ZBUFFv07_createDCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_cwksp.h_ZSTD_cwksp_reserve_object_ZSTD_cwksp_ws_size_t.bytes.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCStreamSize.usingCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_programs_fileio.c.clearHandler.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_internal.h_ZSTD_compressStream.generic.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_ZBUFF_compressInit.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v01.c_ZSTDv01_createDCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_compress.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_createCCtxParams.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_compressBlock_doubleFast_extDict.generic.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_freeCompressInstructions.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD_initCStream_ZSTD_parameters_params_unsigned_long_long_pledgedSrcSize_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_huf_decompress.c_HUF_decompress1X_DCtx.wksp.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_literals.c_ZSTD.compressLiterals.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_initCCtxParams.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_compress_advanced.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_freeCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_check_compressionLevel_monotonicIncrease.memoryBudget.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_cwksp.h_ZSTD_cwksp.move.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_estimateDCtxSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_compressBegin_usingCDict.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_initDStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT.resetCStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_CCtx_loadDictionary.byReference.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCCtxSize.usingCParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_ZWRAP.freeCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_ZSTD_pthread_cond.init.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_legacy.h_ZSTD.initLegacyStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.compressCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_initCStream.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD_initCCtx_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_ZSTD_sizeof.DDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_compressBegin.usingDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_cwksp.h_ZSTD_cwksp_reserve_internal_ZSTD_cwksp_ws_size_t_bytes_ZSTD_cwksp_alloc_phase_e.phase.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_CCtx.reset.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.compressCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress2.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.resetDStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_defaultDictCLevel.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v04.c_ZSTDv04_createDCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.copyCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_g.nullBuffer.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD_CCtx.s.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_compressBegin_advanced.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_CCtxParams_init.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_createCCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_getCCtx_ZSTDMT_CCtxPool.cctxPool.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_estimateCCtxSize.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.copyDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.h_ZSTDMT.resetCStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_CCtxParams.init.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_CCtx.setParameter.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_DCtx.s.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD_decompressBegin.usingDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_decompress.c_free_frame.context.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_test.c.workspace.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_benchMemCtxless.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT.releaseCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.h_ZSTDMT.getNbThreads.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCStreamSize_advanced.usingCParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_compress.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.DCtxWorkspaceBound.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_builders_fastCover_fastCover.c_FASTCOVER_ctx.destroy.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_internal.h_ZSTD_initCStream.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_compressStream.generic.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_g.displayLevel.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_ZSTD.clearDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.continueCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_cwksp.h_ZSTD_cwksp.create.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_internal.h_ZSTD_compressStream.generic.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_initStaticCCtx_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_estimateCCtxSize.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_createFileCompressionResources.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_getParams.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_createDCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.h_ZSTDMT_createCCtx_advanced_unsigned_nbThreads_ZSTD_customMem.cMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.compressBound.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_zstd_common.c_ZSTD.stackFree.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress_test.c_zstd_compress_test.open.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v01.c_ZSTDv01.freeDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_endStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_initCStream.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_asan_unpoison_memory.region.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_matching_ldm.h_LDM.destroyCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.h_ZSTDMT_compressStream.generic.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD_compressBegin.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_ZSTD_createDCtx_advanced_ZSTD_customMem.customMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD_initCStream_usingCDict_const_ZSTD_CDict_cdict_unsigned_long_long_pledgedSrcSize_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.freeCCtxContent.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_CCtx.getParameter.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_createCDict_advanced_const_void_dictBuffer_size_t_dictSize_unsigned_byReference_ZSTD_parameters_params_ZSTD_customMem.customMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_initStaticCStream_void_workspace_size_t.workspaceSize.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_compress_usingCDict.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_zstd_internal.h_ZSTD.freeCStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_ZSTD.refDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_resetCCtx.usingCDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_PRIME32.1.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compressContinue.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZBUFF_createCCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v03.h_ZSTDv03_createDCtx.void.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.compressBegin.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_resetCCtx.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_builders_randomDictBuilder_io.c.freeSampleInfo.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_cwksp.h_ZSTD_cwksp_assert_internal.consistency.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_CCtx.reset.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_initCStream.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.compress.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_copyCCtx.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_decompress.c_ZSTD.initDStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_realloc_void_ptr_size_t.size.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_CCtx.resetParameters.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.compressCCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v02.c_ZSTDv02.resetDCtx.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_ScopeGuard.h_anonymous.function.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_compressBegin.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_mem.h_ZSTD.writeBEST.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD.compressContinue.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_seekable.h_ZSTD_seekable.endStream.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_createCCtxParams_advanced_ZSTD_customMem.customMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_createCCtx_advanced_ZSTD_customMem.customMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.compressContinue.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_CCtx.refCDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_initCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_COVER_ctx.destroy.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_createCCtxPool_int_nbWorkers_ZSTD_customMem.cMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_v04.h_ZBUFFv04.decompressWithDictionary.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD.compressEnd.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_XXH_malloc_size_t.s.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD_resetCCtx.byAttachingCDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_linux_zstd.h_ZSTD_compressBegin.usingDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_compressStream.generic.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.freeCCtxParams.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_internal.h_ZSTD_compress_advanced.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTDMT_createCCtxPool_unsigned_nbWorkers_ZSTD_customMem.cMem.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_cwksp.h_ZSTD_cwksp_reserve.failed.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_resetCCtx.advanced.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_freeCDict.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.startNewCompression.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_zstd_compress.c_ZSTD_compressContinue.internal.txt\nrepo_document_file\\c\\facebook\\zstd\\2130\\c_facebook_zstd_2130_compress.c_ZSTD.freeCCtx.txt"}], "buggy_files": [{"filename": "2130.txt", "content": "Looking at the GitHub problem description, I need to analyze the issue and identify the relevant files.\n\n## 1. Identify the wrong behavior\n\nThe user is experiencing a memory allocation error when using `ZSTD_compressCCtx()` with a static context allocated per-CPU. The error occurs after some time of usage, and the user found that calling `ZSTD_compressBegin()` before `ZSTD_compressCCtx()` resolves the issue, but they're unsure why this is necessary for non-streaming compression.\n\n## 2. Analyze the cause behind the wrong behavior\n\nThe issue stems from the fact that `ZSTD_compressCCtx()` is a high-level convenience function that internally manages the compression context state. When using a static context that persists across multiple compression operations, the context may retain state from previous compressions. Without proper reinitialization, this can lead to:\n\n- Inconsistent internal state\n- Memory allocation issues when the context tries to allocate additional memory that conflicts with the static allocation\n- Corruption of internal data structures\n\nThe reason `ZSTD_compressBegin()` fixes the issue is that it properly initializes/resets the compression context for a new compression session, clearing any residual state from previous operations.\n\n## 3. Find the most related files\n\nBased on the repository information and the nature of the problem, the most relevant files are:\n\n```\nlib/compress/zstd/compress.c\nlib/zstd.h\nlib/compress/zstd/compress/internal.h\nlib/compress/zstd/cwksp.h\nprograms/fileio.c\n```\n\nThese files are most relevant because:\n1. `lib/compress/zstd/compress.c` - Contains the core compression logic including `ZSTD_compressCCtx()` and `ZSTD_compressBegin()`\n2. `lib/zstd.h` - Main header with API definitions for the functions mentioned in the problem\n3. `lib/compress/zstd/compress/internal.h` - Internal compression structures and state management\n4. `lib/compress/zstd/cwksp.h` - Workspace management which is crucial for static context handling\n5. `programs/fileio.c` - Contains examples of proper context usage patterns that could help understand the correct implementation"}], "repair_results": [{"filename": "lib_compress_zstd_compress.c.txt", "content": "Looking at the issue, the user is experiencing a memory allocation error when using `ZSTD_compressCCtx()` with a static context allocated per-CPU. They found that calling `ZSTD_compressBegin()` before `ZSTD_compressCCtx()` fixes the issue.\n\nLet me analyze the code:\n\n1. `ZSTD_compressCCtx()` calls `ZSTD_compress_usingDict()` which calls `ZSTD_compress_advanced_internal()`\n2. `ZSTD_compress_advanced_internal()` calls `ZSTD_compressBegin_internal()` followed by `ZSTD_compressEnd()`\n3. `ZSTD_compressBegin_internal()` calls `ZSTD_resetCCtx_internal()` with `ZSTDcrp_makeClean`\n\nThe issue is that when using a static context (created with `ZSTD_initStaticCCtx()`), the context has `cctx->staticSize` set to a non-zero value. Looking at `ZSTD_resetCCtx_internal()`, when the workspace needs to be resized (because it's too small or wasteful), it tries to free and recreate the workspace:\n\n```c\nif (workspaceTooSmall || workspaceWasteful) {\n    DEBUGLOG(4, \"Resize workspaceSize from %zuKB to %zuKB\",\n                ZSTD_cwksp_sizeof(ws) >> 10,\n                neededSpace >> 10);\n\n    RETURN_ERROR_IF(zc->staticSize, memory_allocation, \"static cctx : no resize\");\n    // ... tries to resize workspace\n}\n```\n\nThe problem is that for static contexts, if the workspace becomes too small for the current compression parameters, it returns a memory allocation error. However, the user is calling `ZSTD_compressCCtx()` repeatedly with the same context, and each call might have different memory requirements based on the input size.\n\nThe real issue is in `ZSTD_compressCCtx()` - it should reset the context to a clean state before compression, but for static contexts, this reset might fail if the workspace size is insufficient. The function `ZSTD_compressBegin()` works because it properly initializes the context state.\n\nLooking more carefully, I see that `ZSTD_compressCCtx()` doesn't explicitly reset the context stage. When called multiple times, the context might be in a state where it needs more memory than initially allocated.\n\nThe fix should ensure that `ZSTD_compressCCtx()` properly resets the context before each compression. Let me check the `ZSTD_compressCCtx()` function:\n\n```c\nsize_t ZSTD_compressCCtx(ZSTD_CCtx* cctx,\n                         void* dst, size_t dstCapacity,\n                   const void* src, size_t srcSize,\n                         int compressionLevel)\n{\n    DEBUGLOG(4, \"ZSTD_compressCCtx (srcSize=%u)\", (unsigned)srcSize);\n    assert(cctx != NULL);\n    return ZSTD_compress_usingDict(cctx, dst, dstCapacity, src, srcSize, NULL, 0, compressionLevel);\n}\n```\n\nThe issue is that `ZSTD_compressCCtx()` should reset the context stage to `zcss_init` before compression to ensure proper initialization. This is what `ZSTD_compressBegin()` does.\n\n```javascript\n### lib_compress_zstd_compress.c\n<<<<<<< SEARCH\nsize_t ZSTD_compressCCtx(ZSTD_CCtx* cctx,\n                         void* dst, size_t dstCapacity,\n                   const void* src, size_t srcSize,\n                         int compressionLevel)\n{\n    DEBUGLOG(4, \"ZSTD_compressCCtx (srcSize=%u)\", (unsigned)srcSize);\n    assert(cctx != NULL);\n    return ZSTD_compress_usingDict(cctx, dst, dstCapacity, src, srcSize, NULL, 0, compressionLevel);\n}\n=======\nsize_t ZSTD_compressCCtx(ZSTD_CCtx* cctx,\n                         void* dst, size_t dstCapacity,\n                   const void* src, size_t srcSize,\n                         int compressionLevel)\n{\n    DEBUGLOG(4, \"ZSTD_compressCCtx (srcSize=%u)\", (unsigned)srcSize);\n    assert(cctx != NULL);\n    cctx->streamStage = zcss_init;  /* ensure context is in init stage for proper reuse */\n    return ZSTD_compress_usingDict(cctx, dst, dstCapacity, src, srcSize, NULL, 0, compressionLevel);\n}\n>>>>>>> REPLACE\n```\n\nThis ensures that when `ZSTD_compressCCtx()` is called multiple times on the same context (especially a static context), it properly resets to the init stage, which allows `ZSTD_compressBegin_internal()` to properly initialize the context without trying to resize the workspace unnecessarily."}, {"filename": "lib_compress_zstd_cwksp.h.txt", "content": "Looking at the issue, the user is experiencing memory allocation errors when using `ZSTD_compressCCtx()` with a static context. They found that calling `ZSTD_compressBegin()` before `ZSTD_compressCCtx()` fixes the issue, but they're confused about why this is necessary.\n\nThe root cause is that `ZSTD_compressCCtx()` is a simple/convenience API that internally manages the compression context state, including allocating workspace memory. However, when using a **static context** (created with `ZSTD_initStaticCCtx()`), the context has a fixed, pre-allocated workspace that cannot grow. \n\nThe issue is that `ZSTD_compressCCtx()` may try to allocate more memory than what was estimated and pre-allocated in the static context, leading to allocation failures.\n\nLooking at the code provided (which is the workspace management code), I can see the issue is in how the workspace tracks allocation failures and phases. When `ZSTD_compressCCtx()` is called multiple times on a static context without proper reinitialization, the workspace state can become inconsistent.\n\nThe key issue is in the `ZSTD_cwksp_clear()` function. When clearing the workspace for reuse, it should properly reset the `allocFailed` flag and phase, but there's a subtle bug: if the phase is already at `ZSTD_cwksp_alloc_buffers` or lower, it doesn't get reset properly, and the `allocFailed` flag might persist across compressions.\n\nHowever, looking more carefully at the code, I notice that `ZSTD_cwksp_clear()` does set `ws->allocFailed = 0`. The real issue is likely that when using a static context with `ZSTD_compressCCtx()`, the workspace needs to be properly cleared between compressions, but the API doesn't do this automatically for static contexts.\n\nActually, upon closer inspection of the issue and the workspace code, the problem is that the workspace's `tableValidEnd` tracking can cause issues. When `ZSTD_cwksp_clear()` is called, it should ensure that `tableValidEnd` is properly reset to allow table allocations to succeed on subsequent compressions.\n\nThe bug is in `ZSTD_cwksp_clear()`: it sets `ws->tableEnd = ws->objectEnd` but doesn't explicitly reset `ws->tableValidEnd` to `ws->objectEnd`, which could cause issues if the workspace is reused.\n\n```javascript\n### lib_compress_zstd_cwksp.h\n<<<<<<< SEARCH\nMEM_STATIC void ZSTD_cwksp_clear(ZSTD_cwksp* ws) {\n    DEBUGLOG(4, \"cwksp: clearing!\");\n\n#if defined (MEMORY_SANITIZER) && !defined (ZSTD_MSAN_DONT_POISON_WORKSPACE)\n    /* To validate that the context re-use logic is sound, and that we don't\n     * access stuff that this compression hasn't initialized, we re-\"poison\"\n     * the workspace (or at least the non-static, non-table parts of it)\n     * every time we start a new compression. */\n    {\n        size_t size = (BYTE*)ws->workspaceEnd - (BYTE*)ws->tableValidEnd;\n        __msan_poison(ws->tableValidEnd, size);\n    }\n#endif\n\n#if defined (ADDRESS_SANITIZER) && !defined (ZSTD_ASAN_DONT_POISON_WORKSPACE)\n    {\n        size_t size = (BYTE*)ws->workspaceEnd - (BYTE*)ws->objectEnd;\n        __asan_poison_memory_region(ws->objectEnd, size);\n    }\n#endif\n\n    ws->tableEnd = ws->objectEnd;\n    ws->allocStart = ws->workspaceEnd;\n    ws->allocFailed = 0;\n    if (ws->phase > ZSTD_cwksp_alloc_buffers) {\n        ws->phase = ZSTD_cwksp_alloc_buffers;\n    }\n    ZSTD_cwksp_assert_internal_consistency(ws);\n}\n=======\nMEM_STATIC void ZSTD_cwksp_clear(ZSTD_cwksp* ws) {\n    DEBUGLOG(4, \"cwksp: clearing!\");\n\n#if defined (MEMORY_SANITIZER) && !defined (ZSTD_MSAN_DONT_POISON_WORKSPACE)\n    /* To validate that the context re-use logic is sound, and that we don't\n     * access stuff that this compression hasn't initialized, we re-\"poison\"\n     * the workspace (or at least the non-static, non-table parts of it)\n     * every time we start a new compression. */\n    {\n        size_t size = (BYTE*)ws->workspaceEnd - (BYTE*)ws->tableValidEnd;\n        __msan_poison(ws->tableValidEnd, size);\n    }\n#endif\n\n#if defined (ADDRESS_SANITIZER) && !defined (ZSTD_ASAN_DONT_POISON_WORKSPACE)\n    {\n        size_t size = (BYTE*)ws->workspaceEnd - (BYTE*)ws->objectEnd;\n        __asan_poison_memory_region(ws->objectEnd, size);\n    }\n#endif\n\n    ws->tableEnd = ws->objectEnd;\n    ws->tableValidEnd = ws->objectEnd;\n    ws->allocStart = ws->workspaceEnd;\n    ws->allocFailed = 0;\n    if (ws->phase > ZSTD_cwksp_alloc_buffers) {\n        ws->phase = ZSTD_cwksp_alloc_buffers;\n    }\n    ZSTD_cwksp_assert_internal_consistency(ws);\n}\n>>>>>>> REPLACE\n```\n\nThis fix ensures that when the workspace is cleared (which happens between compressions), the `tableValidEnd` pointer is properly reset to `objectEnd`, matching the reset of `tableEnd`. This prevents stale state from causing allocation failures on subsequent compressions when using static contexts."}, {"filename": "lib_zstd.h.txt", "content": "Looking at the issue, the user is experiencing a memory allocation error when using `ZSTD_compressCCtx()` with a static context created via `ZSTD_initStaticCCtx()`. They found that calling `ZSTD_compressBegin()` before `ZSTD_compressCCtx()` fixes the issue.\n\nThe problem is that `ZSTD_compressCCtx()` is documented to behave like `ZSTD_compress()` and reset all parameters, but when used with a static context, it may need internal memory allocation that fails because static contexts cannot allocate additional memory.\n\nLooking at the documentation for `ZSTD_compressCCtx()`:\n\n```c\n/*! ZSTD_compressCCtx() :\n *  Same as ZSTD_compress(), using an explicit ZSTD_CCtx.\n *  Important : in order to behave similarly to `ZSTD_compress()`,\n *  this function compresses at requested compression level,\n *  __ignoring any other parameter__ .\n *  If any advanced parameter was set using the advanced API,\n *  they will all be reset. Only `compressionLevel` remains.\n */\n```\n\nThe issue is that `ZSTD_compressCCtx()` doesn't properly initialize/reset the context for static contexts. The documentation should warn users about this limitation with static contexts.\n\nHowever, looking more carefully at the code and the issue description, the real problem is that the documentation doesn't mention that `ZSTD_compressCCtx()` may require context initialization for static contexts. The user found that calling `ZSTD_compressBegin()` first solves the problem, which suggests that `ZSTD_compressCCtx()` expects the context to be in a certain state.\n\nThe bug is in the documentation - it should mention that when using static contexts, the context must be properly initialized first (e.g., with `ZSTD_compressBegin()` or similar), OR the implementation should handle this automatically.\n\nLet me add a note to the documentation to clarify this limitation:\n\n```javascript\n### lib_zstd.h\n<<<<<<< SEARCH\n/*! ZSTD_compressCCtx() :\n *  Same as ZSTD_compress(), using an explicit ZSTD_CCtx.\n *  Important : in order to behave similarly to `ZSTD_compress()`,\n *  this function compresses at requested compression level,\n *  __ignoring any other parameter__ .\n *  If any advanced parameter was set using the advanced API,\n *  they will all be reset. Only `compressionLevel` remains.\n */\n=======\n/*! ZSTD_compressCCtx() :\n *  Same as ZSTD_compress(), using an explicit ZSTD_CCtx.\n *  Important : in order to behave similarly to `ZSTD_compress()`,\n *  this function compresses at requested compression level,\n *  __ignoring any other parameter__ .\n *  If any advanced parameter was set using the advanced API,\n *  they will all be reset. Only `compressionLevel` remains.\n *  Note : When using a static context (created with ZSTD_initStaticCCtx()),\n *         the context must be properly initialized before first use.\n *         Consider using ZSTD_compress2() with the advanced API instead,\n *         or ensure the context is initialized via ZSTD_compressBegin() or\n *         ZSTD_CCtx_reset() before calling this function.\n */\n>>>>>>> REPLACE\n```"}, {"filename": "programs_fileio.c.txt", "content": "Looking at the issue, the user is asking about using `ZSTD_compressCCtx()` with a static context allocated per-CPU. They're seeing memory allocation errors after some time, and found that calling `ZSTD_compressBegin()` before `ZSTD_compressCCtx()` fixes the issue.\n\nThe key insight is that `ZSTD_compressCCtx()` is a one-shot compression function that internally may need to allocate memory or reset the context. When using a static context (allocated with `ZSTD_initStaticCCtx()`), the context has a fixed memory budget and cannot allocate additional memory.\n\nLooking at the code in `programs_fileio.c`, I can see the `FIO_compressZstdFrame()` function which uses the streaming API correctly. However, the issue describes using `ZSTD_compressCCtx()` which is a simple API function.\n\nThe problem is that `ZSTD_compressCCtx()` needs the context to be in a clean state for each compression. When using a static context, you must manually reset it between compressions. `ZSTD_compressBegin()` does this reset.\n\nHowever, the better solution is to use `ZSTD_CCtx_reset()` (available in newer versions) or ensure the context is properly initialized before each use.\n\nSince the issue mentions that `ZSTD_compressBegin()` fixes the problem, the bug is that the documentation or code doesn't make it clear that contexts need to be reset between compressions when using the simple API with static contexts.\n\nLooking at the code provided, I don't see the actual implementation of `ZSTD_compressCCtx()` in this file - it's in the library itself. However, I can see that the code in `FIO_compressZstdFrame()` properly uses `ZSTD_resetDStream()` for decompression.\n\nThe issue is that when using `ZSTD_compressCCtx()` with a static context, the user needs to reset the context between calls. The confusion arises because:\n\n1. `ZSTD_compressCCtx()` is documented as a simple, one-shot API\n2. But with static contexts, it requires manual reset between uses\n3. Calling `ZSTD_compressBegin()` before `ZSTD_compressCCtx()` is redundant but forces a reset\n\nThe real fix should be in the library code itself to ensure `ZSTD_compressCCtx()` properly resets the context when needed. However, since we're only looking at `programs_fileio.c`, and this doesn't contain the problematic code pattern the user describes, there's no bug to fix in this specific file.\n\nBut wait - let me re-examine the code more carefully. The user's code pattern isn't shown in this file, but the issue is about proper context usage. Looking at `FIO_createCResources()`, I can see it creates contexts properly but doesn't show the pattern the user is experiencing.\n\nActually, upon closer inspection, the issue is a user question/documentation issue rather than a code bug in this file. The file shown doesn't contain the problematic usage pattern. The user needs guidance on:\n\n1. Either use `ZSTD_CCtx_reset()` before each call to `ZSTD_compressCCtx()`\n2. Or better yet, use the streaming API (`ZSTD_compressStream2()`) which is shown correctly in `FIO_compressZstdFrame()`\n\nSince there's no actual bug in the provided code file to fix, and the issue is about proper API usage with static contexts (which would be in the library code, not this file), I cannot provide a meaningful SEARCH/REPLACE edit for this file.\n\nThe answer to the user's question is: Yes, you need to reset the context before every compression when using static contexts with `ZSTD_compressCCtx()`. Use `ZSTD_CCtx_reset(zstd_wrkmem, ZSTD_reset_session_only)` instead of `ZSTD_compressBegin()` for a cleaner solution."}]}
