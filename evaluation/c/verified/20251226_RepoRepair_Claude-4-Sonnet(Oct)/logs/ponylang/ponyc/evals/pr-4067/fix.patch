--- a/src/libponyc/codegen/codegen.c
+++ b/src/libponyc/codegen/codegen.c
@@ -985,7 +985,9 @@
 
   if(pony_abi)
   {
-    LLVMValueRef md = LLVMMDNodeInContext(c->context, NULL, 0);
+    LLVMValueRef md_vals[1];
+    md_vals[0] = LLVMConstInt(c->i32, 1, false);
+    LLVMValueRef md = LLVMMDNodeInContext(c->context, md_vals, 1);
     LLVMSetMetadataStr(fun, "pony.abi", md);
   }
 

--- a/src/libponyc/codegen/gencall.c
+++ b/src/libponyc/codegen/gencall.c
@@ -913,8 +913,14 @@
 
       if(is_new_call)
       {
-        LLVMValueRef md = LLVMMDNodeInContext(c->context, NULL, 0);
-        LLVMSetMetadataStr(r, "pony.newcall", md);
+        // Only set metadata on call instructions, not invoke instructions.
+        // Invoke instructions have a different structure in LLVM's CallGraph
+        // and setting metadata on them can cause issues during optimization.
+        if(!ast_canerror(ast) || (c->frame->invoke_target == NULL))
+        {
+          LLVMValueRef md = LLVMMDNodeInContext(c->context, NULL, 0);
+          LLVMSetMetadataStr(r, "pony.newcall", md);
+        }
       }
 
       codegen_debugloc(c, NULL);

--- a/src/libponyc/codegen/genfun.c
+++ b/src/libponyc/codegen/genfun.c
@@ -385,7 +385,6 @@
   // Call the handler.
   codegen_call(c, handler, args, count, true);
   LLVMBuildRetVoid(c->builder);
-  codegen_finishfun(c);
   ponyint_pool_free_size(args_buf_size, args);
   ponyint_pool_free_size(params_buf_size, param_types);
 }
