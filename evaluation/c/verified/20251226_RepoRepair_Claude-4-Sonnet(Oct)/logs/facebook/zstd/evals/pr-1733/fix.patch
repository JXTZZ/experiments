--- a/lib/compress/zstd_compress.c
+++ b/lib/compress/zstd_compress.c
@@ -3634,7 +3634,10 @@
         memset(&cctx->prefixDict, 0, sizeof(cctx->prefixDict));   /* single usage */
         assert(prefixDict.dict==NULL || cctx->cdict==NULL);    /* only one can be set */
         DEBUGLOG(4, "ZSTD_compressStream2 : transparent init stage");
-        if (endOp == ZSTD_e_end) cctx->pledgedSrcSizePlusOne = input->size + 1;  /* auto-fix pledgedSrcSize */
+        if (endOp == ZSTD_e_end) {
+            cctx->pledgedSrcSizePlusOne = input->size + 1;  /* auto-fix pledgedSrcSize */
+            params.fParams.contentSizeFlag = 1;  /* known size, can enable content size flag */
+        }
         params.cParams = ZSTD_getCParamsFromCCtxParams(
                 &cctx->requestedParams, cctx->pledgedSrcSizePlusOne-1, 0 /*dictSize*/);
 

--- a/programs/benchzstd.c
+++ b/programs/benchzstd.c
@@ -233,6 +233,7 @@
                     void* addArgs)
 {
     ZSTD_CCtx* const cctx = (ZSTD_CCtx*)addArgs;
+    ZSTD_CCtx_setPledgedSrcSize(cctx, srcSize);
     return ZSTD_compress2(cctx, dstBuffer, dstSize, srcBuffer, srcSize);
 }
 
